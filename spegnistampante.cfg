


[gcode_macro inizio_spegnimento]
gcode:
  UPDATE_DELAYED_GCODE ID=_done_shutdown_timer DURATION=1



[gcode_macro annulla_spegnimento]
gcode:
  UPDATE_DELAYED_GCODE ID=_done_shutdown_timer DURATION=0



[delayed_gcode _done_shutdown_timer]
initial_duration: 0
gcode:
  {% if printer.extruder.temperature > 50 %}
    UPDATE_DELAYED_GCODE ID=_done_shutdown_timer DURATION=1
  {% else %}
    UPDATE_DELAYED_GCODE ID=_done_shutdown_timer DURATION=0
    _spegnistampante
  {% endif %}

[gcode_macro _spegnistampante]
variable_value: 0
gcode:
  {% if value == 0 %}
    SET_GCODE_VARIABLE MACRO=_spegnistampante VARIABLE=value VALUE=1
    RUN_SHELL_COMMAND CMD=invia_comando_tasmota
    RUN_SHELL_COMMAND CMD=spegni_raspberry
  {% endif %}

  RUN_SHELL_COMMAND CMD=invia_comando_tasmota
  RUN_SHELL_COMMAND CMD=spegni_raspberry


 
[gcode_shell_command spegni_raspberry]
    command: sudo halt
    timeout: 60.
    verbose: True

[gcode_shell_command invia_comando_tasmota]
    command: curl http://192.168.1.127/cm?cmnd=Power2%20ON
    timeout: 60.
    verbose: True


